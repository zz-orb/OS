# lab4

## æ€è€ƒé¢˜

### Thinking 4.1 

> æ€è€ƒå¹¶å›ç­”ä¸‹é¢çš„é—®é¢˜ï¼š
>
> + å†…æ ¸åœ¨ä¿å­˜ç°åœºçš„æ—¶å€™æ˜¯å¦‚ä½•é¿å…ç ´åé€šç”¨å¯„å­˜å™¨çš„ï¼Ÿ

**ç³»ç»Ÿä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€åï¼Œ å†…æ ¸é¦–å…ˆéœ€è¦å°†åŸç”¨æˆ·è¿›ç¨‹çš„è¿è¡Œç°åœºä¿å­˜åˆ°å†…æ ¸ç©ºé—´ï¼ˆåœ¨ kern/entry.S ä¸­é€šè¿‡ SAVE_ALL å®å®Œæˆï¼‰ã€‚**SAVE_ALL å®åªä½¿ç”¨äº†k0å’Œk1ä¸¤ä¸ªé€šç”¨å¯„å­˜å™¨æ¥è¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥ä¿è¯äº†å…¶ä»–é€šç”¨å¯„å­˜å™¨çš„å€¼éƒ½ä¸ä¼šè¢«æ”¹å˜ã€‚

> + ç³»ç»Ÿé™·å…¥å†…æ ¸è°ƒç”¨åå¯ä»¥ç›´æ¥ä»å½“æ—¶çš„ a0-a3 å‚æ•°å¯„å­˜å™¨ä¸­å¾—åˆ°ç”¨æˆ·è°ƒç”¨ msyscallç•™ä¸‹çš„ä¿¡æ¯å—ï¼Ÿ

ä»¥ç›´æ¥è¯»a1-a3å¯„å­˜å™¨ï¼Œä½†ä¸èƒ½è¯»a0å¯„å­˜å™¨ã€‚

ä»ç”¨æˆ·æ€è°ƒç”¨mysyscallåˆ°è¯»å–ä¿¡æ¯å‘ç”Ÿäº†ä¸‹è¿°äº‹ä»¶ï¼š`msyscall`åç³»ç»Ÿé™·å…¥å†…æ ¸ï¼Œè¿›å…¥å¼‚å¸¸åˆ†å‘ç¨‹åºå¹¶è·³è½¬åˆ°`handle_sys`ï¼Œåè°ƒç”¨`do_syscall`å¹¶å°†spå¯„å­˜å™¨ä¸­çš„å€¼ä½œä¸ºå‚æ•°ä¼ é€’ï¼ˆæ›´æ”¹äº†a0å¯„å­˜å™¨ï¼‰ã€‚

> + æˆ‘ä»¬æ˜¯æ€ä¹ˆåšåˆ°è®© sys å¼€å¤´çš„å‡½æ•°â€œè®¤ä¸ºâ€æˆ‘ä»¬æä¾›äº†å’Œç”¨æˆ·è°ƒç”¨ msyscall æ—¶åŒæ ·çš„å‚æ•°çš„ï¼Ÿ

å‚æ•°é€šè¿‡æ ˆä¼ é€’ã€‚åœ¨å†…æ ¸ä¿å­˜ç°åœºæ—¶ï¼Œè¿™äº›æ•°æ®éƒ½ä¼šè¢«ä¿å­˜åˆ°å†…æ ¸æ ˆã€‚

> + å†…æ ¸å¤„ç†ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹å¯¹ Trapframe åšäº†å“ªäº›æ›´æ”¹ï¼Ÿè¿™ç§ä¿®æ”¹å¯¹åº”çš„ç”¨æˆ·æ€çš„å˜åŒ–æ˜¯ä»€ä¹ˆï¼Ÿ

tf->cp0_epcæŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼Œtf->regs[2]ï¼ˆå³v0ï¼‰è®¾ä¸ºå¼‚å¸¸å¤„ç†å‡½æ•°çš„è¿”å›å€¼ã€‚

ç¨‹åºè¿”å›ç”¨æˆ·æ€åèƒ½å¤Ÿä»æ­£ç¡®çš„ä½ç½®ç»§ç»­æ‰§è¡Œï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—ç”¨æˆ·ç¨‹åºä»v0å¯„å­˜å™¨ä¸­è·å¾—**ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼**ã€‚

### Thinking 4.2

> æ€è€ƒ envid2env å‡½æ•°: ä¸ºä»€ä¹ˆ envid2env ä¸­éœ€è¦åˆ¤æ–­ e->env_id != envidçš„æƒ…å†µï¼Ÿå¦‚æœæ²¡æœ‰è¿™æ­¥åˆ¤æ–­ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ

åœ¨æˆ‘ä»¬ç”Ÿæˆenvidæ—¶ï¼Œååä½ä¸ºäº†æ–¹ä¾¿ä»envsæ•°ç»„ä¸­ç›´æ¥å–å‡ºEnvï¼Œå¯èƒ½ä¼šæœ‰æ‰€é‡å ï¼Œenvidçš„ç‹¬ä¸€æ€§å–å†³äºmkenvidé‡Œä¸æ–­å¢é•¿çš„ i ï¼Œæ‰€ä»¥å¦‚æœä¸åˆ¤æ–­envidæ˜¯å¦ç›¸åŒï¼Œä¼šå–åˆ°é”™è¯¯çš„æˆ–è€…æœ¬è¯¥è¢«é”€æ¯çš„è¿›ç¨‹æ§åˆ¶å—ã€‚

ğŸ˜Šfrom:zyå­¦å§

### Thinking 4.3

> æ€è€ƒä¸‹é¢çš„é—®é¢˜ï¼Œå¹¶å¯¹è¿™ä¸ªé—®é¢˜è°ˆè°ˆä½ çš„ç†è§£ï¼šè¯·å›é¡¾ kern/env.c æ–‡ä»¶ä¸­ mkenvid() å‡½æ•°çš„å®ç°ï¼Œè¯¥å‡½æ•°ä¸ä¼šè¿”å› 0ï¼Œè¯·ç»“åˆç³»ç»Ÿè°ƒç”¨å’Œ IPC éƒ¨åˆ†çš„å®ç°ä¸envid2env() å‡½æ•°çš„è¡Œä¸ºè¿›è¡Œè§£é‡Šã€‚

```c
u_int mkenvid(struct Env *e) {
	static u_int i = 0;
	return ((++i) << (1 + LOG2NENV)) | (e - envs);
}
```

mkenvidé€šè¿‡iç¡®ä¿æ¯ä¸ªè¿›ç¨‹idçš„å”¯ä¸€ä¸”éé›¶ã€‚

åœ¨envid2env() å‡½æ•°ä¸­ï¼Œenvidä¸º0æ—¶è¡¨ç¤ºæ˜¯curenvã€‚è®¾ç½®è¯¥å‡½æ•°ä¸­æœ€åä¸€ä¸ªå‚æ•°ä¸º1æ—¶è¿˜å¯ä»¥é€šè¿‡æ£€æŸ¥env_parent_idæ˜¯ä¸æ˜¯ä¸ä¸º0ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯å­è¿›ç¨‹ä»¥å®Œæˆä¸€äº›åªèƒ½åœ¨çˆ¶å­è¿›ç¨‹é—´å‘ç”Ÿç³»ç»Ÿè°ƒç”¨(å¦‚é”€æ¯è¿›ç¨‹)æˆ–é€šä¿¡çš„æƒ…å†µã€‚

### Thinking 4.4

>  å…³äº fork å‡½æ•°çš„ä¸¤ä¸ªè¿”å›å€¼ï¼Œä¸‹é¢è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š
>
> Aã€ fork åœ¨çˆ¶è¿›ç¨‹ä¸­è¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œäº§ç”Ÿä¸¤ä¸ªè¿”å›å€¼
>
> Bã€ fork åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­åˆ†åˆ«è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œäº§ç”Ÿä¸¤ä¸ªä¸åŒçš„è¿”å›å€¼
>
> Cã€ fork åªåœ¨çˆ¶è¿›ç¨‹ä¸­è¢«è°ƒç”¨äº†ä¸€æ¬¡ï¼Œåœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­å„äº§ç”Ÿä¸€ä¸ªè¿”å›å€¼
>
> Dã€ fork åªåœ¨å­è¿›ç¨‹ä¸­è¢«è°ƒç”¨äº†ä¸€æ¬¡ï¼Œåœ¨ä¸¤ä¸ªè¿›ç¨‹ä¸­å„äº§ç”Ÿä¸€ä¸ªè¿”å›å€¼ 

C

### Thinking 4.5 

> æˆ‘ä»¬å¹¶ä¸åº”è¯¥å¯¹æ‰€æœ‰çš„ç”¨æˆ·ç©ºé—´é¡µéƒ½ä½¿ç”¨ duppage è¿›è¡Œæ˜ å°„ã€‚é‚£ä¹ˆç©¶ç«Ÿå“ªäº›ç”¨æˆ·ç©ºé—´é¡µåº”è¯¥æ˜ å°„ï¼Œå“ªäº›ä¸åº”è¯¥å‘¢ï¼Ÿè¯·ç»“åˆ kern/env.c ä¸­ env_init å‡½æ•°è¿›è¡Œçš„é¡µé¢æ˜ å°„ã€include/mmu.h é‡Œçš„å†…å­˜å¸ƒå±€å›¾ä»¥åŠæœ¬ç« çš„åç»­æè¿°è¿›è¡Œæ€è€ƒã€‚

`UTOP`å’Œ`UVPT`ä¹‹é—´å‚¨å­˜çš„æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„pagesä¸envsã€‚åœ¨æ‰§è¡Œ`env_alloc()`å‡½æ•°æ—¶ï¼Œè°ƒç”¨`env_setup_vm`åˆå§‹åŒ–æ–°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œè¿™ä¸€éƒ¨åˆ†çš„æ˜ å°„å…³ç³»ç›´æ¥ä»`boot_pgdir`æ‹·è´åˆ°è¿›ç¨‹é¡µè¡¨ä¸­ï¼Œä¸éœ€è¦è¿›è¡Œæ˜ å°„ã€‚

`USTACKTOP`å’Œ`UTOP`ä¹‹é—´æ˜¯**å¼‚å¸¸å¤„ç†æ ˆï¼ˆuser exception stackï¼‰å’Œæ— æ•ˆå†…å­˜ï¼ˆinvalid memoryï¼‰**ï¼Œå‰è€…æ˜¯è¿›è¡Œå¼‚å¸¸å¤„ç†çš„åœ°æ–¹ï¼Œ åè€…ä¸€èˆ¬ä¹Ÿä¸ä¼šç”¨åˆ°ï¼Œæ‰€ä»¥çˆ¶å­è¿›ç¨‹ä¸éœ€è¦å…±äº«è¿™éƒ¨åˆ†çš„å†…å­˜ã€‚

æ‰€ä»¥ï¼Œæœ€ç»ˆéœ€è¦è¢«æ˜ å°„çš„é¡µé¢**åªæœ‰`USTACKTOP`ä¹‹ä¸‹çš„éƒ¨åˆ†**ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ`UVPT`å’Œ`ULIM`ä¹‹é—´æ˜¯è¿›ç¨‹çš„é¡µè¡¨ï¼Œåœ¨æ˜ å°„USTACKTOPä¹‹ä¸‹çš„éƒ¨åˆ†æ—¶ä¼šéšå¼åœ°å®Œæˆå­è¿›ç¨‹é¡µè¡¨çš„å¡«å†™ï¼Œä¸éœ€è¦æ˜¾ç¤ºåœ°æ˜ å°„çˆ¶è¿›ç¨‹çš„é¡µè¡¨ã€‚

### Thinking 4.6

> åœ¨éå†åœ°å€ç©ºé—´å­˜å–é¡µè¡¨é¡¹æ—¶ä½ éœ€è¦ä½¿ç”¨åˆ° vpd å’Œ vpt è¿™ä¸¤ä¸ªæŒ‡é’ˆï¼Œè¯·å‚è€ƒ user/include/lib.h ä¸­çš„ç›¸å…³å®šä¹‰ï¼Œæ€è€ƒå¹¶å›ç­”è¿™å‡ ä¸ªé—®é¢˜ï¼š

> â€¢ vpt å’Œ vpd çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæ€æ ·ä½¿ç”¨å®ƒä»¬ï¼Ÿ

`vpt`ï¼šæŒ‡å‘ç”¨æˆ·é¡µè¡¨åŸºåœ°å€çš„æŒ‡é’ˆ

==ä»¥vptä¸ºåŸºåœ°å€ï¼ŒåŠ ä¸Šé¡µè¡¨é¡¹åç§»æ•°å³å¯æŒ‡å‘vaå¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œå³vpt[va >> 12] å³ vpt[VPN(va)]ï¼›==

`vpd`ï¼šæŒ‡å‘ç”¨æˆ·é¡µç›®å½•åŸºåœ°å€çš„æŒ‡é’ˆ

ä»¥vpdä¸ºåŸºåœ°å€ï¼ŒåŠ ä¸Šé¡µç›®å½•é¡¹åç§»æ•°å³å¯æŒ‡å‘vaå¯¹åº”é¡µç›®å½•é¡¹ï¼Œå³ vpd[va >> 22]ï¼›

```c
//user/include/lib.h
#define vpt ((const volatile Pte *)UVPT)
#define vpd ((const volatile Pde *)(UVPT + (PDX(UVPT) << PGSHIFT)))
```
> â€¢ ä»å®ç°çš„è§’åº¦è°ˆä¸€ä¸‹ä¸ºä»€ä¹ˆè¿›ç¨‹èƒ½å¤Ÿé€šè¿‡è¿™ç§æ–¹å¼æ¥å­˜å–è‡ªèº«çš„é¡µè¡¨ï¼Ÿ

ä¹‹å‰åœ¨lab3ä¸­å®ç°äº†è‡ªæ˜ å°„
```c
static int env_setup_vm(struct Env *e) {
	//...
    //lab3ä¸­å®ç°äº†è‡ªæ˜ å°„
	/* Step 3: Map its own page table at 'UVPT' with readonly permission.
	 * As a result, user programs can read its page table through 'UVPT' */
	e->env_pgdir[PDX(UVPT)] = PADDR(e->env_pgdir) | PTE_V;
	return 0;
}
```
> â€¢ å®ƒä»¬æ˜¯å¦‚ä½•ä½“ç°è‡ªæ˜ å°„è®¾è®¡çš„ï¼Ÿ

vpdçš„åœ°å€åœ¨UVPTå’ŒUVPT + PDMAPä¹‹é—´ï¼Œè¯´æ˜å°†é¡µç›®å½•æ˜ å°„åˆ°äº†æŸä¸€é¡µè¡¨ä½ç½®ã€‚ä¸€ä¸ªé¡µè¡¨éƒ½è¢«é¡µç›®å½•ä¸­çš„ä¸€ä¸ªé¡µè¡¨é¡¹æ‰€æ˜ å°„ã€‚å› æ­¤"é¡µç›®å½•è¢«æ˜ å°„åˆ°æŸä¸€ä¸ªé¡µè¡¨çš„ä½ç½®"å°±æ„å‘³ç€ï¼Œ**åœ¨é¡µç›®å½•ä¸­ä¸€å®šæœ‰ä¸€ä¸ªé¡µè¡¨é¡¹æ˜ å°„åˆ°äº†é¡µç›®å½•æœ¬èº«**ï¼Œå³å®ç°äº†è‡ªæ˜ å°„ã€‚

> from:hyggge

> â€¢ è¿›ç¨‹èƒ½å¤Ÿé€šè¿‡è¿™ç§æ–¹å¼æ¥ä¿®æ”¹è‡ªå·±çš„é¡µè¡¨é¡¹å—ï¼Ÿ

ä¸èƒ½ï¼Œåœ¨`env_setup_vm`å‡½æ•°ä¸­å¯¹é¡µç›®å½•åªæœ‰åªè¯»æƒé™ã€‚

### Thinking 4.7 

> åœ¨ do_tlb_mod å‡½æ•°ä¸­ï¼Œä½ å¯èƒ½æ³¨æ„åˆ°äº†ä¸€ä¸ªå‘å¼‚å¸¸å¤„ç†æ ˆå¤åˆ¶ Trapframeè¿è¡Œç°åœºçš„è¿‡ç¨‹ï¼Œè¯·æ€è€ƒå¹¶å›ç­”è¿™å‡ ä¸ªé—®é¢˜ï¼š
>
> â€¢ è¿™é‡Œå®ç°äº†ä¸€ä¸ªæ”¯æŒç±»ä¼¼äºâ€œå¼‚å¸¸é‡å…¥â€çš„æœºåˆ¶ï¼Œè€Œåœ¨ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°è¿™ç§â€œå¼‚å¸¸é‡å…¥â€ï¼Ÿ

ç”¨æˆ·æ€çš„é¡µå†™å…¥å¼‚å¸¸å¤„ç†å‡½æ•°æ˜¯ç”¨æˆ·æ€ç¨‹åºè‡ªè¡ŒæŒ‡å®šçš„ï¼Œè™½ç„¶MOSä¸­çš„é¡µå†™å…¥å¼‚å¸¸å¤„ç†å‡½æ•°`cow_entry`åªå¯¹å¼‚å¸¸å¤„ç†æ ˆæ‰€åœ¨çš„é¡µè¿›è¡Œäº†å†™æ“ä½œï¼Œä¸ä¼šå‡ºç°å¼‚å¸¸é‡å…¥ï¼Œä½†ç”¨æˆ·è‡ªè¡ŒæŒ‡å®šçš„å‡½æ•°å´å¯èƒ½ä¼šå‘ç”Ÿå†™å…¥COWæ ‡è®°é¡µé¢è€Œå‘ç”Ÿå¼‚å¸¸é‡å…¥ã€‚
> â€¢ å†…æ ¸ä¸ºä»€ä¹ˆéœ€è¦å°†å¼‚å¸¸çš„ç°åœº Trapframe å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Ÿ

å¼‚å¸¸çš„å¤„ç†æ˜¯åœ¨ç”¨æˆ·æ€è¿›è¡Œçš„ï¼Œç”¨æˆ·æ€æŠŠå¼‚å¸¸å¤„ç†å®Œæ¯•åä»ç„¶åœ¨ç”¨æˆ·æ€æ¢å¤ç°åœºï¼Œæ‰€ä»¥éœ€è¦æŠŠå†…æ ¸ä¿å­˜çš„ç°åœºä¿å­˜åœ¨ç”¨æˆ·ç©ºé—´çš„ç”¨æˆ·å¼‚å¸¸æ ˆã€‚


### Thinking 4.8

> åœ¨ç”¨æˆ·æ€å¤„ç†é¡µå†™å…¥å¼‚å¸¸ï¼Œç›¸æ¯”äºåœ¨å†…æ ¸æ€å¤„ç†æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ 
> 

è§£æ”¾å†…æ ¸ï¼Œä¸ç”¨å†…æ ¸æ‰§è¡Œå¤§é‡çš„é¡µé¢æ‹·è´å·¥ä½œï¼›
å†…æ ¸æ€å¤„ç†å¤±è¯¯äº§ç”Ÿçš„å½±å“è¾ƒå¤§ï¼Œå¯èƒ½ä¼šä½¿å¾—æ“ä½œç³»ç»Ÿå´©æºƒï¼›
ç”¨æˆ·çŠ¶æ€ä¸‹ä¸èƒ½å¾—åˆ°ä¸€äº›åœ¨å†…æ ¸çŠ¶æ€æ‰æœ‰çš„æƒé™ï¼Œé¿å…æ”¹å˜ä¸å¿…è¦çš„å†…å­˜ç©ºé—´ï¼›
æ›´çµæ´»çš„å¤„ç†æ–¹å¼ï¼Œå¯ä»¥æ ¹æ®å…·ä½“çš„åº”ç”¨éœ€æ±‚è¿›è¡Œè‡ªå®šä¹‰çš„å¼‚å¸¸å¤„ç†é€»è¾‘

### Thinking 4.9 

> è¯·æ€è€ƒå¹¶å›ç­”ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š
>
> â€¢ ä¸ºä»€ä¹ˆéœ€è¦å°† syscall_set_tlb_mod_entry çš„è°ƒç”¨æ”¾ç½®åœ¨ syscall_exofork ä¹‹å‰ï¼Ÿ

ä¸æ˜¯å¿…é¡»è¦æŠŠsyscall_set_tlb_mod_entry çš„è°ƒç”¨æ”¾ç½®åœ¨ syscall_exofork ä¹‹å‰ï¼Œåªè¦ä¿è¯åœ¨å†™æ—¶å¤åˆ¶ä¿æŠ¤æœºåˆ¶å®Œæˆä¹‹å‰è®¾ç½®å¥½å³å¯ã€‚

> â€¢ å¦‚æœæ”¾ç½®åœ¨å†™æ—¶å¤åˆ¶ä¿æŠ¤æœºåˆ¶å®Œæˆä¹‹åä¼šæœ‰æ€æ ·çš„æ•ˆæœï¼Ÿ

çˆ¶è¿›ç¨‹è¿è¡Œæ—¶åœ¨å‡½æ•°è°ƒç”¨ç­‰æƒ…å½¢ä¸‹ä¼šä¿®æ”¹æ ˆã€‚åœ¨æ ˆç©ºé—´çš„é¡µé¢æ ‡è®°ä¸ºå†™æ—¶å¤åˆ¶ä¹‹åï¼Œçˆ¶è¿›ç¨‹ç»§ç»­è¿è¡Œå¹¶ä¿®æ”¹æ ˆï¼Œå°±ä¼šè§¦å‘ TLB Mod å¼‚å¸¸ã€‚æ‰€ä»¥åœ¨å†™æ—¶å¤åˆ¶ä¿æŠ¤æœºåˆ¶å®Œæˆä¹‹å‰å°±éœ€è¦ `syscall_set_tlb_mod_entry`ã€‚

## éš¾ç‚¹åˆ†æ

### do_syscall å‡½æ•°çš„åŒ…è£… 

```c
// kern/genex.S
.macro BUILD_HANDLER exception handler
NESTED(handle_\exception, TF_SIZE + 8, zero)
	move    a0, sp
	addiu   sp, sp, -8
	jal     \handler
	addiu   sp, sp, 8
	j       ret_from_exception
END(handle_\exception)
.endm
    
BUILD_HANDLER sys do_syscall
```

 lab0é¢„ä¹ æ•™ç¨‹ä¸­LEAFå’ŒNESTEDçš„å®å®šä¹‰

```c
#define LEAF(symbol)                        \
    .globl  symbol;                         \
    .align  2;                              \
    .type   symbol,@function;               \
    .ent    symbol;                         \
    symbol:                                 \
    .frame  sp,0,ra

#define NESTED(symbol, framesize, rpc)      \
    .globl  symbol;                         \
    .align  2;                              \
    .type   symbol,@function;               \
    .ent    symbol,0;                       \
    symbol:                                 \
    .frame  sp, framesize, rpc
```
+ ç¬¬ä¸€è¡Œæ˜¯å¯¹ LEAF å®çš„å®šä¹‰ï¼Œåé¢æ‹¬å·ä¸­çš„ symbol ç±»ä¼¼äºå‡½æ•°çš„å‚æ•°ï¼Œåœ¨å®å®šä¹‰ä¸­çš„ä½œç”¨ç±»ä¼¼ï¼Œç¼–è¯‘æ—¶åœ¨å®ä¸­ä¼šå°† symbol æ›¿æ¢ä¸ºå®é™…ä¼ å…¥çš„æ–‡æœ¬ï¼Œä¹Ÿå³æˆ‘ä»¬çš„å‡½æ•°åã€‚
+ ç¬¬äºŒè¡Œä¸­ï¼Œ.globl çš„ä½œç”¨æ˜¯â€œä½¿æ ‡ç­¾å¯¹é“¾æ¥å™¨å¯è§â€ï¼Œè¿™æ ·å³ä½¿åœ¨å…¶å®ƒæ–‡ä»¶ä¸­ä¹Ÿå¯ ä»¥å¼•ç”¨åˆ° symbol æ ‡ç­¾ï¼Œä»è€Œä½¿å¾—å…¶å®ƒæ–‡ä»¶ä¸­å¯ä»¥è°ƒç”¨æˆ‘ä»¬ä½¿ç”¨å®å®šä¹‰å£°æ˜çš„å‡½æ•°ã€‚
+ ç¬¬ä¸‰è¡Œä¸­ï¼Œ.align 2 çš„ä½œç”¨æ˜¯â€œä½¿ä¸‹é¢çš„æ•°æ®è¿›è¡Œåœ°å€å¯¹é½â€ï¼Œè¿™ä¸€è¡Œè¯­å¥ä½¿å¾—ä¸‹é¢çš„ symbol æ ‡ç­¾æŒ‰ 4 Byte è¿›è¡Œå¯¹é½ï¼Œä»è€Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ jal æŒ‡ä»¤è·³è½¬åˆ°è¿™ä¸ªå‡½æ•°ï¼ˆæœ«å°¾æ‹¼æ¥ä¸¤ä½ 0ï¼‰ã€‚
+ ç¬¬å››è¡Œä¸­ï¼Œ.type çš„ä½œç”¨æ˜¯è®¾ç½® symbol æ ‡ç­¾çš„ç±»åˆ«ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è®¾ç½®äº† symbol æ ‡ç­¾ä¸ºå‡½æ•°æ ‡ç­¾ã€‚
+ ç¬¬äº”è¡Œä¸­ï¼Œ.ent çš„ä½œç”¨æ˜¯æ ‡è®°æ¯ä¸ªå‡½æ•°çš„å¼€å¤´ï¼Œéœ€è¦ä¸ .end é…å¯¹ä½¿ç”¨ã€‚è¿™äº›æ ‡è®°ä½¿å¾—å¯ä»¥åœ¨ Debug æ—¶æŸ¥çœ‹è°ƒç”¨é“¾

`LEAF` å®å’Œ `NESTED` å®çš„åŒºåˆ«å°±åœ¨äº **`LEAF` å®å®šä¹‰çš„å‡½æ•°åœ¨è¢«è°ƒç”¨æ—¶æ²¡æœ‰åˆ†é…æ ˆå¸§çš„ç©ºé—´è®°å½•è‡ªå·±çš„â€œè¿è¡ŒçŠ¶æ€â€ï¼Œ`NESTED` å®åœ¨è¢«è°ƒç”¨æ—¶åˆ†é…äº†æ ˆå¸§çš„ç©ºé—´ç”¨äºè®°å½•è‡ªå·±çš„â€œè¿è¡ŒçŠ¶æ€â€**ã€‚

```c
#define END(function)                       \
    .end    function;                       \
    .size   function,.-function
```

+ ç¬¬ä¸€è¡Œæ˜¯å¯¹ `END` å®çš„å®šä¹‰ï¼Œä¸ä¸Šé¢ `LEAF` ä¸ `NESTED` ç±»ä¼¼ã€‚

+ ç¬¬äºŒè¡Œçš„ `.end` æ˜¯ä¸ºäº†ä¸å…ˆå‰ `LEAF` æˆ– `NESTED` å£°æ˜ä¸­çš„ `.ent` é…å¯¹ï¼Œæ ‡è®°äº† `symbol` å‡½æ•°çš„ç»“æŸã€‚

+ ç¬¬ä¸‰è¡Œçš„ `.size` æ˜¯æ ‡è®°äº† `function` ç¬¦å·å ç”¨çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼Œå°† `function` ç¬¦å·å ç”¨çš„ç©ºé—´å¤§å°è®¾ç½®ä¸º `.-function`ï¼Œ`.` ä»£è¡¨äº†å½“å‰åœ°å€ï¼Œå½“å‰ä½ç½®çš„åœ°å€å‡å» `function` æ ‡ç­¾å¤„çš„åœ°å€å³å¯è®¡ç®—å‡ºç¬¦å·å ç”¨çš„ç©ºé—´å¤§å°ã€‚

### ç³»ç»Ÿè°ƒç”¨æ—¶ç”¨æˆ·å’Œå†…æ ¸ä¸­éƒ½å‘ç”Ÿäº†ä»€ä¹ˆ

`syscall_* `çš„å‡½æ•°ï¼šç”¨æˆ·ç©ºé—´ä¸­æœ€æ¥è¿‘çš„å†…æ ¸çš„å‡½æ•°

`sys_*` çš„å‡½æ•°ï¼šå†…æ ¸ä¸­ç³»ç»Ÿè°ƒç”¨çš„å…·ä½“å®ç°éƒ¨åˆ†

`syscall_*`çš„å‡½æ•°ä¸å†…æ ¸ä¸­çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼ˆ`sys_*` çš„å‡½æ•°ï¼‰æ˜¯ä¸€ä¸€å¯¹åº”çš„

`syscall_*` çš„å‡½æ•°çš„å®ç°ä¸­ï¼Œéƒ½è°ƒç”¨äº† `msyscall `å‡½æ•°ï¼Œè€Œä¸”å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯ä¸€ä¸ªä¸è°ƒç”¨åç›¸ä¼¼çš„å®ï¼ˆå¦‚SYS_print_consï¼‰ï¼Œåœ¨æˆ‘ä»¬çš„ MOS æ“ä½œç³»ç»Ÿå®éªŒä¸­æŠŠè¿™ä¸ªå‚æ•°ç§°ä¸º==ç³»ç»Ÿè°ƒç”¨å·==ï¼Œå®ƒä»¬è¢«å®šä¹‰åœ¨ include/syscall.hä¸­ã€‚==ç³»ç»Ÿè°ƒç”¨å·==æ˜¯å†…æ ¸åŒºåˆ†ä¸åŒç³»ç»Ÿè°ƒç”¨çš„å”¯ä¸€ä¾æ®ã€‚  

#### `debugf` å’Œç›¸å…³å‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼š

> user/lib/debugf.c
>
> `debugf -> vdebugf -> vprintfmt -> debug_output -> debug_flush`
>
> user/lib/syscall_lib.c
>
> `-> syscall_print_cons->msyscall`


> kern/genex.S
>
> `handle_sys`  
>
> kern/syscall_all.c
>
> `do_syscall`
>
> kern/syscall_all.c
>
> `sys_*`  


> msyscall å‡½æ•°ä¸€å…±æœ‰ 6 ä¸ªå‚æ•°ï¼Œå‰ 4 ä¸ªå‚æ•°ä¼šè¢« syscall_* çš„å‡½æ•°åˆ†åˆ«å­˜å…¥ a0-a3 å¯„å­˜å™¨ï¼ˆå¯„å­˜å™¨ä¼ å‚çš„éƒ¨åˆ†ï¼‰åŒæ—¶æ ˆå¸§åº•éƒ¨ä¿ç•™ 16 å­—èŠ‚çš„ç©ºé—´ï¼ˆä¸è¦æ±‚å­˜å…¥å‚æ•°çš„å€¼ï¼‰ï¼Œå 2 ä¸ªå‚æ•°åªä¼šè¢«å­˜å…¥åœ¨é¢„ç•™ç©ºé—´ä¹‹ä¸Šçš„ 8 å­—èŠ‚ç©ºé—´å†…ï¼ˆæ²¡æœ‰å¯„å­˜å™¨ä¼ å‚ï¼‰ï¼Œäºæ˜¯æ€»å…± 24 å­—èŠ‚çš„ç©ºé—´ç”¨äºå‚æ•°ä¼ é€’ã€‚
>
> C ä»£ç ä¸­çš„è¿™äº›è°ƒç”¨è¿‡ç¨‹ä¼šç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç¼–è¯‘ä¸ºæ±‡ç¼–ä»£ç ï¼Œè€Œæˆ‘ä»¬åœ¨å†…æ ¸ä¸­åˆ™éœ€è¦æ˜¾å¼åœ°ä»ä¿å­˜çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ä¸­è·å–å‡½æ•°çš„å‚æ•°å€¼ã€‚  

Lab3 é‡Œé¢ä¸­æ–­å¼‚å¸¸å¤„ç†çš„è¡Œä¸ºï¼š

1. å¤„ç†å™¨è·³è½¬åˆ°å¼‚å¸¸åˆ†å‘ä»£ç å¤„(kern/entry.S)
2. è¿›å…¥å¼‚å¸¸åˆ†å‘ç¨‹åºï¼Œæ ¹æ® cause å¯„å­˜å™¨å€¼åˆ¤æ–­å¼‚å¸¸ç±»å‹å¹¶è·³è½¬åˆ°å¯¹åº”çš„å¤„ç†ç¨‹åº(genex.S/handle_x)
3. å¤„ç†å¼‚å¸¸ï¼Œå¹¶è¿”å›

### 32ä¸ªå¯„å­˜å™¨

![1482216155_2665](lab4/img/1482216155_2665-1715154845683-2.jpg)

### è¿›ç¨‹é—´é€šä¿¡Envæ§åˆ¶å—ç›¸å…³ä¿¡æ¯

![image-20240508172436630](lab4/img/image-20240508172436630.png)

+ int sys_ipc_recv(u_int dstva)

+ int sys_ipc_try_send(u_int envid, u_int value, u_int srcva, u_int perm)

 		srcva ä¸º 0 çš„è°ƒç”¨è¡¨ç¤ºåªä¼  value å€¼ï¼Œè€Œä¸éœ€è¦ä¼ é€’ç‰©ç†é¡µé¢ï¼›ä¸ä¸º 0 æ—¶ï¼Œæ‰å»ºç«‹ä¸¤ä¸ªè¿›ç¨‹çš„é¡µé¢æ˜ å°„å…³ç³»ã€‚

+ è¿›ç¨‹é“¾è¡¨ç›¸å…³

```c
1. ç©ºé—²è¿›ç¨‹æ§åˆ¶å—é“¾è¡¨env_free_list -> env_link
	è·å–ç¬¬ä¸€ä¸ª: e = LIST_FIRST(&env_free_list);
	éå†: LIST_FOREACH(e, &env_free_list, env_link);
	å¼€å¤´æ’å…¥: LIST_INSERT_HEAD(&env_free_list, e, env_link);
	ç§»é™¤: LIST_REMOVE(e, env_link);
2. è°ƒåº¦è¿›ç¨‹é˜Ÿåˆ—é“¾è¡¨env_sched_list -> env_sched_link
	è·å–ç¬¬ä¸€ä¸ª: e = TAILQ_FIRST(&env_sched_list);
	éå†: TAILQ_FOREACH(e, &env_sched_list, env_sched_link);
	å¼€å¤´æ’å…¥: TAILQ_INSERT_HEAD(&env_sched_list, e, env_sched_link);
	ç»“å°¾æ’å…¥: TAILQ_INSERT_HEAD(&env_sched_list, e, env_sched_link);
	ç§»é™¤: TAILQ_REMOVE(&env_sched_list, e, env_sched_link);
```



### forkç›¸å…³

#### æ¶‰åŠå‡½æ•°

â€¢ kern/syscall_all.cï¼š `sys_exofork`ï¼Œ `sys_set_env_status` ï¼Œ `sys_set_tlb_mod_entry`

â€¢ kern/tlbex.cï¼š `do_tlb_mod` è´Ÿè´£å®Œæˆå†™æ—¶å¤åˆ¶å¤„ç†==å‰==çš„ç›¸å…³è®¾ç½®

â€¢ user/lib/fork.cï¼š

+ `fork`
+ `cow_entry` ï¼šå†™æ—¶å¤åˆ¶å¤„ç†çš„å‡½æ•°ï¼Œä¹Ÿæ˜¯å†…æ ¸ä¼šä» `do_tlb_mod`è¿”å›åˆ°çš„å‡½æ•°ï¼Œè´Ÿè´£å¯¹å¸¦æœ‰ PTE_COW æ ‡å¿—çš„é¡µé¢è¿›è¡Œå¤„ç†
+ `duppage` ï¼šçˆ¶è¿›ç¨‹å¯¹å­è¿›ç¨‹é¡µé¢ç©ºé—´è¿›è¡Œæ˜ å°„ä»¥åŠç›¸å…³æ ‡å¿—è®¾ç½®çš„å‡½æ•°

#### å‡½æ•°è°ƒç”¨å…³ç³»

![c173f9438ee35ab23a06fff417b6182](lab4/img/c173f9438ee35ab23a06fff417b6182.png)

forkå‡½æ•°æµç¨‹ï¼š

![image-20240522163904256](lab4/img/image-20240522163904256.png)

---

â€¢ user/lib/entry.Sï¼šç”¨æˆ·è¿›ç¨‹çš„å…¥å£

â€¢ user/lib/libos.cï¼šç”¨æˆ·è¿›ç¨‹å…¥å£çš„ C è¯­è¨€éƒ¨åˆ†ï¼Œè´Ÿè´£å®Œæˆæ‰§è¡Œç”¨æˆ·ç¨‹åº main å‰åçš„å‡†å¤‡å’Œæ¸…ç†å·¥ä½œ

â€¢ kern/genex.Sï¼šè¯¥æ–‡ä»¶å®ç°äº† MOS çš„å¼‚å¸¸å¤„ç†æµç¨‹ï¼Œè™½ç„¶ä¸æ˜¯æˆ‘ä»¬éœ€è¦å®ç°çš„é‡ç‚¹ï¼Œä½†æ˜¯å»ºè®®è¯»è€…è®¤çœŸé˜…è¯»ï¼Œç†è§£ä¸­æ–­å¤„ç†çš„æµç¨‹ã€‚

## å®éªŒä½“ä¼š

lab4-1ï¼šexamè€ƒå¯Ÿå¢åŠ ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤
lab4-2ï¼šexamè€ƒå¯Ÿçˆ¶å­è¿›ç¨‹ä¹‹é—´çš„IPCé€šä¿¡ï¼ŒextraèƒŒæ™¯æ˜¯å†…æ ¸æ§åˆ¶çš„è¿›ç¨‹ç¨‹ã€‚

æ„Ÿè§‰éš¾ç‚¹è¿˜æ˜¯è¦ç†Ÿæ‚‰ç³»ç»Ÿè°ƒç”¨çš„æµç¨‹ï¼Œå‡†ç¡®è®¤è¯†åˆ°ä»€ä¹ˆæ—¶å€™åœ¨ç”¨æˆ·æ€ä»€ä¹ˆæ—¶å€™åœ¨å†…æ ¸æ€ã€‚(æ·»åŠ ç³»ç»Ÿè°ƒç”¨éœ€è¦æ”¹å˜çš„æ–‡ä»¶ä¸€å®šè¦ç†ŸçŸ¥å•Š)

é™¤æ­¤ä¹‹å¤–å°±æ˜¯æŒæ¡IPCã€forkç›¸å…³å‡½æ•°ä½œç”¨åŠå¯¹åº”å‚æ•°çš„å«ä¹‰ï¼Œä»¥ä¾¿è¿ç”¨ã€‚
